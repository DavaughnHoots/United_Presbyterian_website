<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold mb-2" style="color: var(--text-primary);"><%= contentType.pluralName %> Library</h1>
            <p class="text-gray-600"><%= contentType.description %></p>
        </div>
        <div class="flex gap-2">
            <button data-action="import" class="btn-secondary">
                <i class="fas fa-upload mr-2"></i>Import
            </button>
            <button data-action="export" class="btn-secondary">
                <i class="fas fa-download mr-2"></i>Export
            </button>
            <button data-action="add-new" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>Add New <%= contentType.name %>
            </button>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="module-card mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Category</label>
                <select id="categoryFilter" data-filter="category" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">All Categories</option>
                    <% contentType.categories.forEach(function(category) { %>
                        <option value="<%= category.toLowerCase() %>"><%= category %></option>
                    <% }) %>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Search</label>
                <input type="text" id="searchFilter" placeholder="Search <%= contentType.pluralName.toLowerCase() %>..." 
                       data-filter="search" 
                       class="w-full px-3 py-2 border rounded-lg">
            </div>
            <% if (contentType.fields.season) { %>
            <div>
                <label class="block text-sm font-medium mb-2">Season</label>
                <select id="seasonFilter" data-filter="season" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">All Seasons</option>
                    <% contentType.fields.season.options.forEach(function(season) { %>
                        <option value="<%= season.toLowerCase() %>"><%= season %></option>
                    <% }) %>
                </select>
            </div>
            <% } else if (contentType.fields.author || contentType.fields.artist) { %>
            <div>
                <label class="block text-sm font-medium mb-2"><%= contentType.fields.author ? 'Author' : 'Artist' %></label>
                <input type="text" id="authorFilter" placeholder="Filter by <%= contentType.fields.author ? 'author' : 'artist' %>..." 
                       data-filter="author" 
                       class="w-full px-3 py-2 border rounded-lg">
            </div>
            <% } else { %>
            <div>
                <label class="block text-sm font-medium mb-2">Theme</label>
                <input type="text" id="themeFilter" placeholder="Filter by theme..." 
                       data-filter="theme" 
                       class="w-full px-3 py-2 border rounded-lg">
            </div>
            <% } %>
            <div>
                <label class="block text-sm font-medium mb-2">Sort By</label>
                <select id="sortBy" data-action="sort" class="w-full px-3 py-2 border rounded-lg">
                    <option value="title">Title</option>
                    <option value="category">Category</option>
                    <% if (contentType.fields.author || contentType.fields.artist) { %>
                        <option value="author"><%= contentType.fields.author ? 'Author' : 'Artist' %></option>
                    <% } %>
                    <option value="recent">Recently Added</option>
                    <option value="usage">Most Used</option>
                </select>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="mt-4 pt-4 border-t grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
                <span class="text-gray-600">Total:</span>
                <span class="font-semibold ml-2" id="totalCount">0</span>
            </div>
            <div>
                <span class="text-gray-600">Active:</span>
                <span class="font-semibold ml-2 text-green-600" id="activeCount">0</span>
            </div>
            <div>
                <span class="text-gray-600">Categories:</span>
                <span class="font-semibold ml-2" id="categoryCount">0</span>
            </div>
            <div>
                <span class="text-gray-600">Filtered:</span>
                <span class="font-semibold ml-2" id="filteredCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- Item List -->
    <div id="itemList" class="space-y-4">
        <% if (items && items.length > 0) { %>
            <% items.forEach(function(item) { %>
                <div class="module-card item-card" 
                     data-id="<%= item.id %>"
                     data-category="<%= item.category %>"
                     data-author="<%= (item.author || '').toLowerCase() %>"
                     data-theme="<%= (item.theme || '').toLowerCase() %>"
                     data-season="<%= (item.season || '').toLowerCase() %>"
                     data-title="<%= item.title.toLowerCase() %>"
                     data-active="<%= item.is_active %>">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="category-badge category-<%= item.category %>">
                                    <i class="fas <%= contentType.icon %> mr-1"></i>
                                    <%= item.category.charAt(0).toUpperCase() + item.category.slice(1) %>
                                </span>
                                <% if (!item.is_active) { %>
                                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-700 text-xs rounded">Inactive</span>
                                <% } %>
                                <% if (item.usage_count > 0) { %>
                                    <span class="ml-2 text-sm text-gray-600">
                                        <i class="fas fa-chart-bar mr-1"></i>Used <%= item.usage_count %> times
                                    </span>
                                <% } %>
                            </div>
                            
                            <h3 class="text-lg font-semibold mb-1"><%= item.title %></h3>
                            
                            <% if (item.biblePassage) { %>
                                <p class="text-sm text-gray-600 mb-2">
                                    <i class="fas fa-bible mr-1"></i><%= item.biblePassage %>
                                </p>
                            <% } %>
                            
                            <% if (item.author || item.artist) { %>
                                <p class="text-sm text-gray-600 mb-2">
                                    <i class="fas fa-user mr-1"></i><%= item.author || item.artist %>
                                </p>
                            <% } %>
                            
                            <% if (item.duration_minutes) { %>
                                <p class="text-sm text-gray-600 mb-2">
                                    <i class="fas fa-clock mr-1"></i><%= item.duration_minutes %> minutes
                                </p>
                            <% } %>
                            
                            <div class="content-preview line-clamp-3">
                                <%= item.content || item.instructions || '' %>
                            </div>
                            
                            <% if (item.tags && item.tags.length > 0) { %>
                                <div class="mt-2">
                                    <% item.tags.forEach(function(tag) { %>
                                        <span class="inline-block px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded mr-2 mb-1">
                                            <%= tag %>
                                        </span>
                                    <% }) %>
                                </div>
                            <% } %>
                            
                            <div class="mt-2 flex flex-wrap gap-2 text-sm">
                                <% if (item.audio_url) { %>
                                    <span class="text-blue-600"><i class="fas fa-headphones mr-1"></i>Audio</span>
                                <% } %>
                                <% if (item.video_url || item.youtubeId) { %>
                                    <span class="text-red-600"><i class="fas fa-video mr-1"></i>Video</span>
                                <% } %>
                                <% if (item.image_url) { %>
                                    <span class="text-green-600"><i class="fas fa-image mr-1"></i>Image</span>
                                <% } %>
                            </div>
                        </div>
                        
                        <div class="ml-4 flex items-center space-x-2">
                            <button data-action="preview" data-item-id="<%= item.id %>" 
                                    class="text-indigo-600 hover:bg-indigo-50 p-2 rounded" title="Preview">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button data-action="edit" data-item-id="<%= item.id %>" 
                                    class="text-blue-600 hover:bg-blue-50 p-2 rounded" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button data-action="toggle" data-item-id="<%= item.id %>" data-is-active="<%= item.is_active %>" 
                                    class="<%= item.is_active ? 'text-yellow-600 hover:bg-yellow-50' : 'text-green-600 hover:bg-green-50' %> p-2 rounded" 
                                    title="<%= item.is_active ? 'Deactivate' : 'Activate' %>">
                                <i class="fas <%= item.is_active ? 'fa-pause' : 'fa-play' %>"></i>
                            </button>
                            <button data-action="delete" data-item-id="<%= item.id %>" 
                                    class="text-red-600 hover:bg-red-50 p-2 rounded" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="module-card text-center py-12">
                <i class="fas <%= contentType.icon %> text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-500">No <%= contentType.pluralName.toLowerCase() %> found. Add your first <%= contentType.name.toLowerCase() %> to get started!</p>
            </div>
        <% } %>
    </div>
    
    <!-- Empty State (hidden by default) -->
    <div id="emptyState" class="module-card text-center py-12" style="display: none;">
        <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
        <p class="text-gray-500">No <%= contentType.pluralName.toLowerCase() %> match your filters.</p>
        <button data-action="reset-filters" class="btn btn-sm btn-secondary mt-4">
            Reset Filters
        </button>
    </div>
</div>

<!-- Add/Edit Modal -->
<div id="contentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 id="modalTitle" class="text-2xl font-bold">Add New <%= contentType.name %></h2>
                    <button data-action="close-modal" data-modal="contentModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="contentForm" data-action="save-item">
                <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                    <input type="hidden" id="itemId" name="id">
                    
                    <!-- Dynamic form fields based on content type -->
                    <% Object.entries(contentType.fields).forEach(function([fieldName, field]) { %>
                        <% if (field.type === 'array') { %>
                            <!-- Array field (for prompts, questions, etc.) -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2"><%= field.label %><% if (field.required) { %>*<% } %></label>
                                <div id="<%= fieldName %>Container" class="space-y-2">
                                    <!-- Array items will be added dynamically -->
                                </div>
                                <button type="button" data-action="add-array-item" data-field="<%= fieldName %>" 
                                        class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-plus mr-1"></i>Add <%= field.label.slice(0, -1) %>
                                </button>
                            </div>
                        <% } else if (field.type === 'select') { %>
                            <!-- Select field -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2"><%= field.label %><% if (field.required) { %>*<% } %></label>
                                <select id="<%= fieldName %>" name="<%= fieldName %>" <% if (field.required) { %>required<% } %> 
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Select <%= field.label %></option>
                                    <% field.options.forEach(function(option) { %>
                                        <option value="<%= option.toLowerCase() %>"><%= option %></option>
                                    <% }) %>
                                </select>
                            </div>
                        <% } else if (field.type === 'textarea') { %>
                            <!-- Textarea field -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2"><%= field.label %><% if (field.required) { %>*<% } %></label>
                                <textarea id="<%= fieldName %>" name="<%= fieldName %>" rows="<%= field.rows || 4 %>" 
                                          <% if (field.required) { %>required<% } %>
                                          class="w-full px-3 py-2 border rounded-lg"><%= field.placeholder || '' %></textarea>
                            </div>
                        <% } else if (field.type === 'number') { %>
                            <!-- Number field -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2"><%= field.label %><% if (field.required) { %>*<% } %></label>
                                <input type="number" id="<%= fieldName %>" name="<%= fieldName %>" 
                                       <% if (field.default) { %>value="<%= field.default %>"<% } %>
                                       <% if (field.required) { %>required<% } %>
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        <% } else { %>
                            <!-- Text/URL field -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2"><%= field.label %><% if (field.required) { %>*<% } %></label>
                                <input type="<%= field.type === 'url' ? 'url' : 'text' %>" 
                                       id="<%= fieldName %>" name="<%= fieldName %>" 
                                       placeholder="<%= field.placeholder || '' %>"
                                       <% if (field.required) { %>required<% } %>
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        <% } %>
                    <% }) %>
                    
                    <!-- Category field (common to all) -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Category*</label>
                        <select id="itemCategory" name="category" required class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Select Category</option>
                            <% contentType.categories.forEach(function(category) { %>
                                <option value="<%= category.toLowerCase() %>"><%= category %></option>
                            <% }) %>
                        </select>
                    </div>
                    
                    <!-- Active status -->
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="itemIsActive" name="is_active" checked class="mr-2">
                            <span class="text-sm">Active (available for use)</span>
                        </label>
                    </div>
                </div>
                
                <div class="p-6 border-t flex justify-end space-x-3">
                    <button type="button" data-action="close-modal" data-modal="contentModal" 
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Save <%= contentType.name %>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold"><%= contentType.name %> Preview</h2>
                    <button data-action="close-modal" data-modal="previewModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="previewContent" class="p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Import <%= contentType.pluralName %></h2>
                    <button data-action="close-modal" data-modal="importModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                <!-- Tab buttons -->
                <div class="flex border-b mb-4">
                    <button id="fileImportTab" data-tab="file" class="px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-file-upload mr-2"></i>Upload File
                    </button>
                    <button id="jsonImportTab" data-tab="json" class="px-4 py-2 font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-code mr-2"></i>Paste JSON
                    </button>
                    <button id="exampleTab" data-tab="example" class="px-4 py-2 font-medium text-gray-600 hover:text-gray-800">
                        <i class="fas fa-lightbulb mr-2"></i>Example Template
                    </button>
                </div>
                
                <!-- File Upload Tab -->
                <div id="fileImportContent" class="tab-content">
                    <p class="text-gray-600 mb-4">Upload a JSON file containing <%= contentType.pluralName.toLowerCase() %> to import.</p>
                    <input type="file" id="importFile" accept=".json" class="mb-4 w-full px-3 py-2 border rounded-lg">
                    <div class="bg-blue-50 p-4 rounded-lg text-sm">
                        <p class="font-semibold text-blue-800 mb-2">File Format Tips:</p>
                        <ul class="list-disc list-inside text-blue-700 space-y-1">
                            <li>File must be valid JSON format</li>
                            <li>Can import single item or array of items</li>
                            <li>Each item must have at least a title</li>
                            <li>See Example Template tab for proper format</li>
                        </ul>
                    </div>
                </div>
                
                <!-- JSON Input Tab -->
                <div id="jsonImportContent" class="tab-content hidden">
                    <p class="text-gray-600 mb-4">Paste your JSON data below. Can be a single item or an array of items.</p>
                    <textarea id="jsonInput" rows="12" class="w-full px-3 py-2 border rounded-lg font-mono text-sm" 
                              placeholder='[
  {
    "title": "Your <%= contentType.name %> Title",
    "content": "Content goes here...",
    "category": "category-name"
  }
]'></textarea>
                    <div class="mt-2 flex justify-between items-center">
                        <button data-action="validate-json" class="text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-check-circle mr-1"></i>Validate JSON
                        </button>
                        <span id="jsonValidation" class="text-sm"></span>
                    </div>
                </div>
                
                <!-- Example Template Tab -->
                <div id="exampleContent" class="tab-content hidden">
                    <p class="text-gray-600 mb-4">Here's a complete example showing all available fields for <%= contentType.pluralName.toLowerCase() %>:</p>
                    <div class="bg-gray-100 p-4 rounded-lg overflow-x-auto">
                        <pre id="exampleTemplate" class="text-sm font-mono whitespace-pre"></pre>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button data-action="copy-example" class="btn-secondary">
                            <i class="fas fa-copy mr-2"></i>Copy Example
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t flex justify-end space-x-3">
                <button data-action="close-modal" data-modal="importModal" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button data-action="import-confirm" class="btn-primary">
                    <i class="fas fa-upload mr-2"></i>Import
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.category-badge {
    @apply px-3 py-1 rounded-full text-sm font-medium;
}

/* Dynamic category colors */
<% contentType.categories.forEach(function(category) { %>
.category-<%= category.toLowerCase() %> { 
    @apply bg-<%= contentType.color %>-100 text-<%= contentType.color %>-700; 
}
<% }) %>

.content-preview {
    white-space: pre-line;
}
</style>

<!-- Initialize content data -->
<script id="initialContentData" type="application/json">
<%- JSON.stringify(items || []) %>
</script>

<script id="contentTypeConfig" type="application/json">
<%- JSON.stringify(contentType) %>
</script>

<script>
(function() {
  'use strict';
  
  // Debug: Check if ContentTypeManager is being loaded
  console.log('Content type page loaded for <%= contentType.dbType %>');
  console.log('Initial ContentTypeManager exists:', typeof window.ContentTypeManager !== 'undefined');
  console.log('Initial ContentTypeManager.ModalManager exists:', typeof window.ContentTypeManager?.ModalManager !== 'undefined');
  
  // Check again after scripts should have loaded
  window.addEventListener('load', function() {
    console.log('After page load - ContentTypeManager exists:', typeof window.ContentTypeManager !== 'undefined');
    console.log('After page load - ContentTypeManager.ModalManager exists:', typeof window.ContentTypeManager?.ModalManager !== 'undefined');
    if (window.ContentTypeManager?.ModalManager) {
      console.log('ModalManager methods:', Object.keys(window.ContentTypeManager.ModalManager));
    }
  });
  
  // Add error handlers for script loading
  window.addEventListener('error', function(e) {
    if (e.target.tagName === 'SCRIPT') {
      console.error('Failed to load script:', e.target.src);
    }
  }, true);
})();
</script>

<!-- Load modular JavaScript files with cache busting -->
<script src="/js/admin/content-type-manager-core.js?v=<%= Date.now() %>"></script>
<script src="/js/admin/content-type-filter-manager.js?v=<%= Date.now() %>"></script>
<script src="/js/admin/content-type-form-manager.js?v=<%= Date.now() %>"></script>
<script src="/js/admin/content-type-modal-manager.js?v=<%= Date.now() %>"></script>
<script src="/js/admin/content-type-export-import.js?v=<%= Date.now() %>"></script>
<script src="/js/admin/content-type-manager-init.js?v=<%= Date.now() %>"></script>

<!-- Fallback in case scripts don't load -->
<script>
(function() {
  // Wait a moment to see if scripts loaded
  setTimeout(function() {
    if (!window.ContentTypeManager || !window.ContentTypeManager.ModalManager) {
      console.error('ContentTypeManager failed to load. Creating fallback...');
      
      // Create minimal fallback
      window.ContentTypeManager = window.ContentTypeManager || {};
      window.ContentTypeManager.ModalManager = {
        openAddModal: function() {
          alert('JavaScript files failed to load. Please refresh the page.');
        },
        closeModal: function() {
          const modal = document.getElementById('contentModal');
          if (modal) modal.classList.add('hidden');
        }
      };
      
      // Try to provide basic functionality
      window.ContentTypeManager.FilterManager = {
        filterItems: function() { console.log('Filter not available'); },
        sortItems: function() { console.log('Sort not available'); },
        resetFilters: function() { console.log('Reset not available'); }
      };
      
      window.ContentTypeManager.showImportModal = function() {
        alert('Import functionality not available. Please refresh the page.');
      };
      
      window.ContentTypeManager.exportItems = function() {
        alert('Export functionality not available. Please refresh the page.');
      };
    } else {
      console.log('ContentTypeManager loaded successfully');
    }
  }, 100);
})();
</script>