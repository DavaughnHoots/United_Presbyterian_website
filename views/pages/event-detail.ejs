<!-- JSON-LD for SEO -->
<script type="application/ld+json">
<%- jsonLd %>
</script>

<div class="max-w-4xl mx-auto">
    <!-- Back Navigation -->
    <div class="mb-6">
        <a href="/events" class="text-sky-blue hover:underline flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Back to Events
        </a>
    </div>

    <!-- Event Header -->
    <div class="module-card mb-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold mb-2"><%= event.title %></h1>
                <% if (event.categories && event.categories.length > 0) { %>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <% event.categories.forEach(category => { %>
                            <span class="px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700">
                                <%= category %>
                            </span>
                        <% }) %>
                    </div>
                <% } %>
            </div>
            <div class="event-category-badge <%= event.category %> text-2xl">
                <i class="fas <%= getCategoryIcon(event.category) %>"></i>
            </div>
        </div>

        <!-- Event Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <h3 class="font-semibold text-gray-700 mb-2">Date & Time</h3>
                <div class="space-y-2">
                    <div>
                        <i class="fas fa-calendar mr-2 text-sky-blue"></i>
                        <% if (event.allDay) { %>
                            <%= new Date(event.startDate).toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                year: 'numeric',
                                month: 'long', 
                                day: 'numeric' 
                            }) %>
                            <% if (new Date(event.startDate).toDateString() !== new Date(event.endDate).toDateString()) { %>
                                - <%= new Date(event.endDate).toLocaleDateString('en-US', { 
                                    weekday: 'long', 
                                    year: 'numeric',
                                    month: 'long', 
                                    day: 'numeric' 
                                }) %>
                            <% } %>
                        <% } else { %>
                            <%= new Date(event.startDate).toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                year: 'numeric',
                                month: 'long', 
                                day: 'numeric' 
                            }) %>
                        <% } %>
                    </div>
                    <% if (!event.allDay && event.startTime) { %>
                        <div>
                            <i class="fas fa-clock mr-2 text-sky-blue"></i>
                            <% 
                                // Convert 24-hour time to 12-hour format with AM/PM
                                const [hours, minutes] = event.startTime.split(':');
                                const hour = parseInt(hours);
                                const period = hour >= 12 ? 'PM' : 'AM';
                                const displayHour = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
                            %>
                            <%= displayHour %>:<%= minutes %> <%= period %>
                            <% if (event.endTime) { %>
                                <% 
                                    const [endHours, endMinutes] = event.endTime.split(':');
                                    const endHour = parseInt(endHours);
                                    const endPeriod = endHour >= 12 ? 'PM' : 'AM';
                                    const displayEndHour = endHour === 0 ? 12 : (endHour > 12 ? endHour - 12 : endHour);
                                %>
                                - <%= displayEndHour %>:<%= endMinutes %> <%= endPeriod %>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            </div>

            <div>
                <h3 class="font-semibold text-gray-700 mb-2">Location</h3>
                <div>
                    <i class="fas fa-map-marker-alt mr-2 text-sky-blue"></i>
                    <%= event.location || 'United Presbyterian Church' %>
                </div>
            </div>
        </div>

        <% if (event.description) { %>
            <div class="mb-6">
                <h3 class="font-semibold text-gray-700 mb-2">Description</h3>
                <p class="text-gray-600 whitespace-pre-wrap"><%= event.description %></p>
            </div>
        <% } %>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3">
            <!-- Add to Calendar -->
            <div class="relative group">
                <button class="btn btn-primary flex items-center" id="addToCalendarBtn">
                    <i class="fas fa-calendar-plus mr-2"></i>
                    Add to Calendar
                    <i class="fas fa-chevron-down ml-2"></i>
                </button>
                
                <!-- Dropdown Menu -->
                <div class="absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden group-hover:block z-10" id="calendarDropdown">
                    <div class="py-1">
                        <a href="/events/<%= event.id %>/ics" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-download mr-2"></i> Download .ics file
                        </a>
                        <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=<%= encodeURIComponent(event.title) %>&dates=<%= event.allDay ? new Date(event.startDate).toISOString().slice(0,10).replace(/-/g,'') : new Date(event.startDate).toISOString().replace(/[-:]/g,'').slice(0,15) %>/<%= event.allDay ? new Date(new Date(event.endDate).getTime() + 86400000).toISOString().slice(0,10).replace(/-/g,'') : new Date(event.endDate).toISOString().replace(/[-:]/g,'').slice(0,15) %>&details=<%= encodeURIComponent(event.description || '') %>&location=<%= encodeURIComponent(event.location || 'United Presbyterian Church') %>" 
                           target="_blank" 
                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fab fa-google mr-2"></i> Google Calendar
                        </a>
                        <a href="https://outlook.live.com/calendar/0/deeplink/compose?subject=<%= encodeURIComponent(event.title) %>&startdt=<%= event.allDay ? new Date(event.startDate).toISOString().slice(0,10).replace(/-/g,'') : new Date(event.startDate).toISOString().replace(/[-:]/g,'').slice(0,15) %>&enddt=<%= event.allDay ? new Date(new Date(event.endDate).getTime() + 86400000).toISOString().slice(0,10).replace(/-/g,'') : new Date(event.endDate).toISOString().replace(/[-:]/g,'').slice(0,15) %>&body=<%= encodeURIComponent(event.description || '') %>&location=<%= encodeURIComponent(event.location || 'United Presbyterian Church') %>" 
                           target="_blank" 
                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fab fa-microsoft mr-2"></i> Outlook
                        </a>
                    </div>
                </div>
            </div>

            <% if (event.link) { %>
                <a href="<%= event.link %>" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">
                    <i class="fas fa-external-link-alt mr-2"></i>
                    More Information
                </a>
            <% } %>

            <% if (event.externalUrl) { %>
                <a href="<%= event.externalUrl %>" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">
                    <i class="fas fa-link mr-2"></i>
                    Learn More
                </a>
            <% } %>

            <% if (event.registrationRequired) { %>
                <button class="btn btn-success">
                    <i class="fas fa-user-plus mr-2"></i>
                    Register
                </button>
            <% } %>
        </div>
    </div>

    <% if (event.isRecurring) { %>
        <div class="module-card">
            <div class="flex items-center text-gray-600">
                <i class="fas fa-sync-alt mr-2 text-sky-blue"></i>
                This is a recurring event
                <% if (event.recurringPattern) { %>
                    (<%= event.recurringPattern %>)
                <% } %>
            </div>
        </div>
    <% } %>
</div>

<script>
// Add to Calendar dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    const addToCalendarBtn = document.getElementById('addToCalendarBtn');
    const calendarDropdown = document.getElementById('calendarDropdown');
    
    addToCalendarBtn.addEventListener('click', function(e) {
        e.preventDefault();
        calendarDropdown.classList.toggle('hidden');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!addToCalendarBtn.contains(e.target) && !calendarDropdown.contains(e.target)) {
            calendarDropdown.classList.add('hidden');
        }
    });
});
</script>

<!-- Helper function -->
<%
function getCategoryIcon(category) {
    const icons = {
        'worship': 'fa-church',
        'bible-study': 'fa-book-bible',
        'fellowship': 'fa-hands-holding-heart',
        'service': 'fa-hand-holding-heart',
        'meeting': 'fa-users',
        'special': 'fa-star',
        'Holiday': 'fa-calendar-star',
        'Religious': 'fa-church',
        'Awareness': 'fa-info-circle',
        'Season': 'fa-calendar',
        'Social Justice': 'fa-balance-scale',
        'Commemoration': 'fa-monument'
    };
    return icons[category] || 'fa-calendar-alt';
}
%>