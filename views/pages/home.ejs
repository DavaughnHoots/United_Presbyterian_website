<div class="max-w-6xl mx-auto">
    <% if (welcomeMessage) { %>
        <!-- Welcome Alert -->
        <div class="module-card mb-6 bg-gradient-to-r from-sky-blue to-heaven-blue text-white">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-2xl mr-3"></i>
                <p class="font-medium"><%= welcomeMessage %></p>
            </div>
        </div>
    <% } %>
    
    <!-- Interactive Greeting Card -->
    <div class="greeting-card mb-6 cursor-pointer hover:shadow-lg transition-all duration-300" 
         id="greetingCard" onclick="handleGreetingClick()">
        <p class="text-gray-500 text-sm" id="greetingName">Hi <%= user ? user.firstName : 'Friend' %></p>
        <h1 class="text-3xl font-bold text-gray-800" id="greetingText">Good Morning</h1>
        <div class="hidden" id="greetingClicked">
            <p class="text-2xl" id="greetingEmoji">üòä</p>
            <h1 class="text-2xl font-bold text-sky-blue" id="greetingMessage">Nice to see you today!</h1>
        </div>
    </div>
    
    <!-- Daily Content Preview -->
    <div class="module-card mb-6">
        <h3 class="text-xl font-semibold mb-4">Today's Spiritual Journey</h3>
        <div class="space-y-3">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-book-bible text-sky-blue"></i>
                </div>
                <div class="flex-1">
                    <p class="font-medium">Daily Reading</p>
                    <p class="text-sm text-gray-600">John 3:16</p>
                </div>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-pray text-sky-blue"></i>
                </div>
                <div class="flex-1">
                    <p class="font-medium">Morning Prayer</p>
                    <p class="text-sm text-gray-600">Start your day with God</p>
                </div>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-music text-sky-blue"></i>
                </div>
                <div class="flex-1">
                    <p class="font-medium">Hymn of the Day</p>
                    <p class="text-sm text-gray-600">Amazing Grace</p>
                </div>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </div>
        </div>
        <a href="/daily" class="btn-primary w-full text-center mt-4">Explore Today's Content</a>
    </div>
    
    <% if (currentEvent) { %>
        <!-- Happening Now Section -->
        <div class="module-card mb-6 border-2 border-red-500 bg-red-50 relative overflow-hidden">
            <div class="absolute top-0 right-0 bg-red-500 text-white px-3 py-1 rounded-bl-lg text-sm font-bold flex items-center gap-2">
                <span class="animate-pulse">‚óè</span> HAPPENING NOW
            </div>
            <div class="pt-8">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">
                            <%= currentEvent.title %>
                        </h3>
                        <div class="space-y-2 text-sm">
                            <% if (currentEvent.location) { %>
                                <div class="flex items-center gap-2 text-gray-600">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span><%= currentEvent.location %></span>
                                </div>
                            <% } %>
                            <div class="flex items-center gap-2 text-gray-600">
                                <i class="fas fa-clock"></i>
                                <span>
                                    <% if (currentEvent.timeRemaining > 60) { %>
                                        Ends in <%= Math.floor(currentEvent.timeRemaining / 60) %> hours <%= currentEvent.timeRemaining % 60 %> minutes
                                    <% } else { %>
                                        Ends in <%= currentEvent.timeRemaining %> minutes
                                    <% } %>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="event-category-badge <%= currentEvent.category %> text-2xl">
                        <i class="fas <%= getCategoryIcon(currentEvent.category) %>"></i>
                    </div>
                </div>
                <% if (currentEvent.link) { %>
                    <div class="mt-4">
                        <a href="<%= currentEvent.link %>" target="_blank" rel="noopener noreferrer" 
                           class="inline-flex items-center gap-2 px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium">
                            <i class="fas fa-video"></i>
                            Join Now
                        </a>
                    </div>
                <% } %>
            </div>
        </div>
    <% } %>
    
    <% if (!currentEvent && upcomingEvents && upcomingEvents.length > 0) { %>
        <!-- Upcoming Today Section -->
        <div class="module-card mb-6 bg-blue-50 border border-blue-200">
            <h3 class="text-lg font-semibold mb-3 text-blue-900">Coming Up Today</h3>
            <div class="space-y-3">
                <% upcomingEvents.forEach(event => { %>
                    <div class="flex items-center gap-3">
                        <div class="event-category-badge <%= event.category %> flex-shrink-0">
                            <i class="fas <%= getCategoryIcon(event.category) %>"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-medium"><%= event.title %></p>
                            <p class="text-sm text-gray-600">
                                <% if (event.timeUntil < 60) { %>
                                    Starts in <%= event.timeUntil %> minutes
                                <% } else { %>
                                    Starts at <%= event.startDateTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) %>
                                <% } %>
                                <% if (event.location) { %>
                                    ‚Ä¢ <%= event.location %>
                                <% } %>
                            </p>
                        </div>
                        <% if (event.link) { %>
                            <a href="<%= event.link %>" target="_blank" rel="noopener noreferrer" 
                               class="text-sky-blue hover:text-blue-700">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        <% } %>
                    </div>
                <% }) %>
            </div>
        </div>
    <% } %>
    
    <% if (user && user.isAdmin) { %>
        <!-- Admin Quick Access -->
        <div class="mb-6 text-center">
            <a href="/admin" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-full hover:from-purple-600 hover:to-purple-700 transition shadow-lg">
                <i class="fas fa-shield-alt"></i>
                <span class="font-medium">Admin Dashboard</span>
            </a>
        </div>
    <% } %>
    
    <!-- Quick Actions Grid -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <!-- Events Card -->
        <div class="module-card">
            <div class="icon-circle">
                <i class="fas fa-calendar-alt text-sky-blue"></i>
            </div>
            <h3 class="text-lg font-semibold text-center mb-2">Events</h3>
            <p class="text-sm text-gray-600 text-center mb-4">Upcoming church activities</p>
            <a href="/events" class="btn-primary w-full text-center">View All</a>
        </div>
        
        <!-- Connect Card -->
        <div class="module-card">
            <div class="icon-circle">
                <i class="fas fa-hands-praying text-sky-blue"></i>
            </div>
            <h3 class="text-lg font-semibold text-center mb-2">Connect</h3>
            <p class="text-sm text-gray-600 text-center mb-4">Join our community</p>
            <a href="/share" class="btn-primary w-full text-center">Share</a>
        </div>
    </div>
    
    <!-- Church Image Card -->
    <div class="image-card mb-6">
        <img src="/img/church.jpg" alt="<%= churchName %>">
        <div class="overlay">
            <h2 class="text-2xl font-bold mb-1"><%= churchName %></h2>
            <p class="text-sm opacity-90">A Community of Faith & Love</p>
        </div>
    </div>
    
    <!-- Service Times Card -->
    <div class="service-card mb-6">
        <h3 class="text-xl font-semibold mb-2">Next Service</h3>
        <p class="text-3xl font-bold mb-1">Sunday 11:00 AM</p>
        <p class="text-sm opacity-90">Join us for worship</p>
        <a href="https://www.google.com/maps/dir/?api=1&destination=<%= encodedAddress %>" target="_blank" rel="noopener noreferrer" class="btn-light mt-4">Get Directions</a>
    </div>
    
    <% if (user) { %>
        <!-- User Progress Section -->
        <div class="module-card" id="progressCard">
            <h3 class="text-xl font-semibold mb-4">Your Spiritual Progress</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="text-2xl font-bold text-sky-blue" id="currentStreak"><%= user.currentStreak || 0 %></p>
                    <p class="text-sm text-gray-600">Current Streak</p>
                    <% if (user.currentStreak >= 7) { %>
                        <span class="text-xs text-orange-500">üî• On fire!</span>
                    <% } %>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="text-2xl font-bold text-green-600" id="daysActive"><%= user.totalDaysActive || 0 %></p>
                    <p class="text-sm text-gray-600">Days Active</p>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <% const progressPercent = Math.min(100, Math.round(((user.totalDaysActive || 0) / 30) * 100)); %>
                <div class="bg-gradient-to-r from-sky-blue to-heaven-blue h-2 rounded-full transition-all duration-500" 
                     style="width: <%= progressPercent %>%" id="progressBar"></div>
            </div>
            <p class="text-sm text-gray-600 mt-2" id="progressMessage">
                <% if (user.currentStreak >= 30) { %>
                    üéâ Amazing dedication! 30+ day streak!
                <% } else if (user.currentStreak >= 7) { %>
                    üåü Great job! Keep your streak going!
                <% } else if (user.currentStreak >= 1) { %>
                    üí™ You're on a <%= user.currentStreak %> day streak!
                <% } else { %>
                    Complete daily content to build your streak!
                <% } %>
            </p>
        </div>
    <% } else { %>
        <!-- Join Community Card -->
        <div class="module-card text-center">
            <div class="icon-circle mx-auto">
                <i class="fas fa-users text-sky-blue"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2">Join Our Community</h3>
            <p class="text-gray-600 mb-4">Create an account to track your spiritual journey and connect with our church family.</p>
            <a href="/auth/register" class="btn-primary">Get Started</a>
        </div>
    <% } %>
</div>

<%
// Helper function embedded in template
function getCategoryIcon(category) {
    const icons = {
        'worship': 'fa-pray',
        'bible-study': 'fa-book-bible',
        'fellowship': 'fa-users',
        'service': 'fa-hands-helping',
        'meeting': 'fa-comments',
        'special': 'fa-star'
    };
    return icons[category] || 'fa-calendar';
}
%>

<script>
// Interactive greeting functionality
let hasGreetingBeenClicked = false;
let greetingMessageIndex = 0;
let wiggleInterval;

// Array of positive greeting messages with emojis
const greetingMessages = [
    { emoji: 'üòä', message: 'Nice to see you today!' },
    { emoji: 'üåü', message: 'You are blessed!' },
    { emoji: 'üíñ', message: 'God loves you!' },
    { emoji: 'üôè', message: 'Have a blessed day!' },
    { emoji: '‚ú®', message: 'You are amazing!' },
    { emoji: 'üåà', message: 'Hope shines through you!' },
    { emoji: 'üïäÔ∏è', message: 'Peace be with you!' },
    { emoji: 'üí™', message: 'Stay strong in faith!' },
    { emoji: 'üåª', message: 'Keep growing!' },
    { emoji: '‚≠ê', message: 'You shine bright!' },
    { emoji: 'üéâ', message: 'Rejoice in today!' },
    { emoji: 'üíù', message: 'You are cherished!' },
    { emoji: 'üå∫', message: 'Beautiful soul!' },
    { emoji: 'üî•', message: 'Faith on fire!' },
    { emoji: 'üå∏', message: 'Bloom where you are!' },
    { emoji: 'üëë', message: 'Child of the King!' },
    { emoji: 'üéµ', message: 'Sing a new song!' },
    { emoji: 'üåÖ', message: 'New mercies today!' },
    { emoji: 'üí´', message: 'Walking in purpose!' },
    { emoji: 'üèÜ', message: 'Victory is yours!' }
];

function handleGreetingClick() {
    if (hasGreetingBeenClicked) return; // Only allow one click per animation cycle
    
    const greetingName = document.getElementById('greetingName');
    const greetingText = document.getElementById('greetingText');
    const greetingClickedElement = document.getElementById('greetingClicked');
    const greetingCard = document.getElementById('greetingCard');
    const greetingEmoji = document.getElementById('greetingEmoji');
    const greetingMessage = document.getElementById('greetingMessage');
    
    // Get next message (random selection for more variety)
    // Avoid showing the same message twice in a row
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * greetingMessages.length);
    } while (newIndex === greetingMessageIndex && greetingMessages.length > 1);
    greetingMessageIndex = newIndex;
    const currentGreeting = greetingMessages[greetingMessageIndex];
    
    // Update the greeting content
    greetingEmoji.textContent = currentGreeting.emoji;
    greetingMessage.textContent = currentGreeting.message;
    
    // Hide original content
    greetingName.style.display = 'none';
    greetingText.style.display = 'none';
    
    // Show clicked content
    greetingClickedElement.classList.remove('hidden');
    
    // Add animation
    greetingCard.classList.add('animate-bounce');
    setTimeout(() => {
        greetingCard.classList.remove('animate-bounce');
    }, 1000);
    
    // Track the interaction
    fetch('/api/analytics/greeting-click', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            timeOfDay: getTimeOfDay(),
            message: currentGreeting.message
        })
    }).catch(err => console.error('Failed to track greeting click:', err));
    
    hasGreetingBeenClicked = true;
    
    // Stop wiggle interval when user interacts
    if (wiggleInterval) {
        clearInterval(wiggleInterval);
    }
    
    // Revert after 3 seconds (shorter to encourage more clicks)
    setTimeout(() => {
        greetingName.style.display = 'block';
        greetingText.style.display = 'block';
        greetingClickedElement.classList.add('hidden');
        hasGreetingBeenClicked = false;
        
        // Resume wiggle hints after a delay
        setTimeout(() => {
            startWiggleHint();
        }, 5000);
    }, 3000);
}

// Get time of day for greeting
function getTimeOfDay() {
    const hour = new Date().getHours();
    if (hour < 12) return 'morning';
    if (hour < 17) return 'afternoon';
    return 'evening';
}

// Update greeting based on time of day
function updateGreeting() {
    const hour = new Date().getHours();
    const greetingElement = document.getElementById('greetingText');
    if (!greetingElement) return;
    
    let greeting = 'Good Morning';
    if (hour >= 12 && hour < 17) {
        greeting = 'Good Afternoon';
    } else if (hour >= 17) {
        greeting = 'Good Evening';
    }
    
    greetingElement.textContent = greeting;
}

// Function to start wiggle hint animation
function startWiggleHint() {
    const greetingCard = document.getElementById('greetingCard');
    
    // Initial wiggle after 3 seconds
    setTimeout(() => {
        if (!hasGreetingBeenClicked) {
            greetingCard.classList.add('wiggle-hint');
            setTimeout(() => {
                greetingCard.classList.remove('wiggle-hint');
            }, 800); // Duration of 2 wiggles
        }
    }, 3000);
    
    // Then wiggle every 8 seconds
    wiggleInterval = setInterval(() => {
        if (!hasGreetingBeenClicked) {
            greetingCard.classList.add('wiggle-hint');
            setTimeout(() => {
                greetingCard.classList.remove('wiggle-hint');
            }, 800); // Duration of 2 wiggles
        }
    }, 8000);
}

// Update greeting on page load
document.addEventListener('DOMContentLoaded', function() {
    updateGreeting();
    
    // Start the wiggle hints
    startWiggleHint();
    
    // Clean up interval when user leaves page
    window.addEventListener('beforeunload', () => {
        if (wiggleInterval) clearInterval(wiggleInterval);
    });
    
    // Fetch latest progress stats if user is logged in
    <% if (user) { %>
    fetch('/api/progress/stats')
        .then(res => res.json())
        .then(data => {
            // Update progress display with latest data
            document.getElementById('currentStreak').textContent = data.currentStreak;
            document.getElementById('daysActive').textContent = data.totalDaysActive;
            document.getElementById('progressBar').style.width = data.progressPercentage + '%';
            
            // Update message based on streak
            const messageEl = document.getElementById('progressMessage');
            if (data.currentStreak >= 30) {
                messageEl.textContent = 'üéâ Amazing dedication! 30+ day streak!';
            } else if (data.currentStreak >= 7) {
                messageEl.textContent = 'üåü Great job! Keep your streak going!';
            } else if (data.currentStreak >= 1) {
                messageEl.textContent = `üí™ You're on a ${data.currentStreak} day streak!`;
            }
        })
        .catch(err => console.error('Failed to fetch progress:', err));
    <% } %>
});
</script>